// Implement factorial function using FSM instead of for loop (which will result in a non-converging loop condition during build)

module factorial (
    input clk,  // clock
    input rst,  // reset
    input x[16],
    output s[16]
  ) {
  
  .clk(clk), .rst(rst) {
    fsm factorial_state = {BEGIN, MULTIPLY, END};
    dff counter[16];
    dff trans_out[16];
  }

  always {
    trans_out.d = trans_out.q;
    counter.d = counter.q;
    s = 0;

    case (factorial_state.q) {
      factorial_state.BEGIN:
        trans_out.d = 1;
        counter.d = 1;

        if ($unsigned(x) == 0) {
          factorial_state.d = factorial_state.END;
        }
        
        else {
          factorial_state.d = factorial_state.MULTIPLY;
        }

      factorial_state.MULTIPLY:
        trans_out.d = trans_out.q * counter.q;

        if (counter.q == $unsigned(x)) {
          factorial_state.d = factorial_state.END;
        }

        else {
          counter.d = counter.q + 1;
        }

      factorial_state.END:
        counter.d = counter.q;
        s = trans_out.q;
      
      default:
        s = 0;
  }
}